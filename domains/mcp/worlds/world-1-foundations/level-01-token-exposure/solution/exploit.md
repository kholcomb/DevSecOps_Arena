# Solution: MCP Token Leakage

## Overview

This challenge demonstrates **MCP01:2025 - Token Mismanagement & Secret Exposure**, where an MCP server leaks sensitive information through error messages and allows reading of configuration files.

## Exploitation Steps

### Step 1: Configure Your AI Agent

Point your AI agent (Claude Desktop, or any MCP-compatible client) to the MCP gateway:

**Gateway URL:** `http://localhost:8900/mcp`

Note: You only need to configure this once! The gateway will route to different backend servers as you switch challenges.

### Step 2: Discover Available Tools

Ask your AI agent: **"What MCP tools are available?"**

Expected response:
- `read_file` - Read file contents from workspace
- `list_directory` - List directory contents

### Step 3: Trigger Error Message (Method 1)

Ask your agent: **"Use the read_file tool without providing a path argument"**

The server will return an error message containing:
```
Error: Path required. Debug info: API_KEY=sk-super-secret-key-ABCD1234567890XYZ, Server=File Manager MCP Server
```

üö® **Vulnerability**: The server leaks its API key in the error message!

### Step 4: List Directory Contents

Ask your agent: **"List the root directory"**

Response will show:
```
Files:
- .env (configuration file)
- README.md
- src/
- data/
- logs/
```

Notice the `.env` file - this often contains secrets!

### Step 5: Extract the Flag

Ask your agent: **"Read the file /.env"**

The server returns:
```
# Environment Configuration
API_KEY=sk-super-secret-key-ABCD1234567890XYZ
FLAG=ARENA{MCP01_T0k3n_L34k4g3_1s_D4ng3r0us}
DB_PASSWORD=super_secret_password_123
AWS_ACCESS_KEY=AKIA1234567890EXAMPLE
```

üèÅ **Flag Found:** `ARENA{MCP01_T0k3n_L34k4g3_1s_D4ng3r0us}`

### Step 6: Submit the Flag

Run in your terminal:
```bash
arena validate ARENA{MCP01_T0k3n_L34k4g3_1s_D4ng3r0us}
```

## Alternative Methods

**Method 2: Path Traversal Attempt**

Trying to read an absolute path like `/etc/passwd` also leaks internal paths:
```
Error: Absolute paths not allowed. Workspace root: /home/mcp-server/workspace/, Requested: /etc/passwd
```

This reveals the server's internal directory structure.

## Lessons Learned

1. **Never include sensitive data in error messages**
2. **Sanitize error responses before returning to clients**
3. **Don't expose debug information in production**
4. **Restrict access to sensitive files like .env**
5. **Use proper error handling that doesn't leak state**

## Real-World Impact

Similar vulnerabilities have led to:
- Leaked OpenAI API keys ($$$$ in unauthorized usage)
- Exposed database credentials leading to data breaches
- Service account tokens enabling lateral movement
- AWS credentials allowing cloud resource compromise
